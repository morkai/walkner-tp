// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const EMPTY = Buffer.from('iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAANSURBVBhXY2BgYGAAAAAFAAGKM+MAAAAAAElFTkSuQmCC', 'base64');

module.exports = async (app, {User}, req, res) =>
{
  const user = await User
    .findById(req.params.id)
    .select({picture: 1})
    .lean()
    .exec();

  if (!user || !user.picture)
  {
    res.type('png');
    res.end(EMPTY);

    return;
  }

  const buffer = Buffer.from(user.picture.replace('data:image/jpeg;base64,', ''), 'base64');

  res.type('jpg');
  res.end(buffer);
};

