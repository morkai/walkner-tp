// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const gm = require('gm');

module.exports = async (app, module, req, res, next) =>
{
  if (typeof req.body.picture !== 'string'
    || !/^data:image\/(jpeg|png);base64,[A-Za-z0-9+/=]{1024,5242880}$/.test(req.body.picture))
  {
    delete req.body.picture;

    return next();
  }

  const [, type, base64] = req.body.picture.match(/^data:image\/(jpeg|png);base64,(.*?)$/);

  gm(Buffer.from(base64, 'base64'), `WMES_USER_PICTURE.${type === 'jpeg' ? 'jpg' : 'png'}`)
    .autoOrient()
    .quality(95)
    .resize(95, 140, '>')
    .noProfile()
    .toBuffer('jpg', (err, buffer) =>
    {
      if (err)
      {
        return next(err);
      }

      req.body.picture = `data:image/jpeg;base64,${buffer.toString('base64')}`;

      next();
    });
};
