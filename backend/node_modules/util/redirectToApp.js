// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = ({settings, setting}, req, res, next) =>
{
  const userIp = req.session && req.session.user && req.session.user.ipAddress || '127.0.0.1';
  const urlPrefix = '://' + userIp.split('.').slice(0, 2).join('.') + '.';

  settings.findById(setting, (err, setting) =>
  {
    if (err)
    {
      return next(err);
    }

    if (!setting || !Array.isArray(setting.value) || !setting.value.length)
    {
      return res.sendStatus(404);
    }

    const target = setting.value.find(target => target.includes(urlPrefix));

    res.redirect(target ? target : setting.value[0]);
  });
};
